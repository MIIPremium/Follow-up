<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة حفظ المتون - الجامعة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: all 0.3s ease-in-out;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 leading-relaxed">

    <!-- Main application content -->
    <div id="app" class="p-4 md:p-8">
        <header class="bg-gray-900 text-white text-center p-6 rounded-lg shadow-lg mb-8">
            <h1 class="text-3xl md:text-4xl font-bold">نظام متابعة حفظ المتون - الجامعة</h1>
        </header>
        
        <nav class="bg-blue-600 rounded-lg shadow-lg mb-8 p-2">
            <ul class="flex flex-col md:flex-row justify-center items-center">
                <li><a href="#" onclick="showSection('students')" class="block py-2 px-4 md:mx-2 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-300">إدارة الطلاب</a></li>
                <li><a href="#" onclick="showSection('texts')" class="block py-2 px-4 md:mx-2 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-300">إدارة المتون</a></li>
                <li><a href="#" onclick="showSection('progress')" class="block py-2 px-4 md:mx-2 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-300">تسجيل التقدم</a></li>
            </ul>
        </nav>

        <main class="container mx-auto">
            <!-- Student Management Section -->
            <section id="students" class="section bg-white p-6 rounded-lg shadow-lg mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b-2 pb-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 md:mb-0">إدارة الطلاب</h2>
                    <div id="user-info" class="text-sm text-gray-500"></div>
                </div>
                
                <div class="card bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                    <div class="text-lg font-bold text-gray-700 mb-4">إضافة طالب جديد</div>
                    <form id="addStudentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" id="studentName" placeholder="اسم الطالب" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="studentCollege" placeholder="الكلية" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="studentMajor" placeholder="التخصص" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="studentLevel" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">المستوى الأول</option>
                            <option value="2">المستوى الثاني</option>
                            <option value="3">المستوى الثالث</option>
                            <option value="4">المستوى الرابع</option>
                        </select>
                        <button type="submit" class="col-span-1 md:col-span-2 lg:col-span-4 bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-300">إضافة الطالب</button>
                    </form>
                </div>
                
                <div class="card bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <div class="text-lg font-bold text-gray-700 mb-4">قائمة الطلاب</div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                            <thead class="bg-gray-200 text-gray-600">
                                <tr>
                                    <th class="py-3 px-4 text-center border-b-2">الاسم</th>
                                    <th class="py-3 px-4 text-center border-b-2">الكلية</th>
                                    <th class="py-3 px-4 text-center border-b-2">التخصص</th>
                                    <th class="py-3 px-4 text-center border-b-2">المستوى</th>
                                    <th class="py-3 px-4 text-center border-b-2">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Data will be loaded here by JavaScript -->
                                <tr class="text-center"><td colspan="5" class="py-4 text-gray-500">جاري تحميل البيانات...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Text Management Section -->
            <section id="texts" class="section bg-white p-6 rounded-lg shadow-lg mb-6 hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b-2 pb-4">إدارة المتون</h2>
                <div class="tabs flex flex-wrap border-b border-gray-300 mb-6">
                    <button class="tab p-3 cursor-pointer bg-gray-200 rounded-t-lg mx-1 transition duration-300 active" onclick="showTextTab('stage1')">المرحلة الأولى</button>
                    <button class="tab p-3 cursor-pointer bg-gray-200 rounded-t-lg mx-1 transition duration-300" onclick="showTextTab('stage2')">المرحلة الثانية</button>
                    <button class="tab p-3 cursor-pointer bg-gray-200 rounded-t-lg mx-1 transition duration-300" onclick="showTextTab('stage3')">المرحلة الثالثة</button>
                    <button class="tab p-3 cursor-pointer bg-gray-200 rounded-t-lg mx-1 transition duration-300" onclick="showTextTab('stage4')">المرحلة الرابعة</button>
                </div>
                
                <div id="stage1Texts" class="text-tab">
                    <div class="card bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                        <div class="text-lg font-bold text-gray-700 mb-4">إضافة متن جديد للمرحلة الأولى</div>
                        <form id="addStage1TextForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="stage1TextName" placeholder="اسم المتن" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="number" id="stage1TextTotal" placeholder="العدد الكلي" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="col-span-1 md:col-span-2 bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-300">إضافة المتن</button>
                        </form>
                    </div>
                    
                    <div class="card bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <div class="text-lg font-bold text-gray-700 mb-4">متون المرحلة الأولى</div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                                <thead class="bg-gray-200 text-gray-600">
                                    <tr>
                                        <th class="py-3 px-4 text-center border-b-2">اسم المتن</th>
                                        <th class="py-3 px-4 text-center border-b-2">المجموع الكلي</th>
                                        <th class="py-3 px-4 text-center border-b-2">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="stage1TextsTableBody">
                                    <!-- Data will be loaded here by JavaScript -->
                                    <tr class="text-center"><td colspan="3" class="py-4 text-gray-500">جاري تحميل البيانات...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Other stages sections can be added here -->
            </section>

            <!-- Progress Recording Section -->
            <section id="progress" class="section bg-white p-6 rounded-lg shadow-lg mb-6 hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b-2 pb-4">تسجيل التقدم في الحفظ</h2>
                <div class="card bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <form id="recordProgressForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="progressStudent" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- اختر الطالب --</option>
                        </select>
                        <select id="progressStage" required onchange="loadStageTexts()" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- اختر المرحلة --</option>
                            <option value="1">المرحلة الأولى</option>
                            <option value="2">المرحلة الثانية</option>
                            <option value="3">المستوى الثالث</option>
                            <option value="4">المستوى الرابع</option>
                        </select>
                        <select id="progressText" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- اختر المتن --</option>
                        </select>
                        <input type="number" id="progressAmount" placeholder="القدر المحفوظ (مكان الوقف)" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="date" id="progressDate" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="col-span-1 md:col-span-2 bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-300">تسجيل التقدم</button>
                    </form>
                </div>
            </section>

            <!-- Reports are not implemented in this version -->
            <section id="weekly" class="section bg-white p-6 rounded-lg shadow-lg mb-6 hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b-2 pb-4">التقارير الأسبوعية</h2>
                <div class="text-center py-12 text-gray-500">
                    هذه الميزة سيتم تطويرها في إصدارات مستقبلية.
                </div>
            </section>
            <section id="monthly" class="section bg-white p-6 rounded-lg shadow-lg mb-6 hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b-2 pb-4">التقارير الشهرية</h2>
                <div class="text-center py-12 text-gray-500">
                    هذه الميزة سيتم تطويرها في إصدارات مستقبلية.
                </div>
            </section>
        </main>
    </div>

    <!-- Custom Modal for Confirmation/Alerts -->
    <div id="customModal" class="modal fixed inset-0 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 z-50 hidden">
        <div class="modal-content bg-white rounded-lg p-6 shadow-xl w-full max-w-sm transform scale-95 opacity-0">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modalButtons" class="flex justify-end gap-2">
                <button id="modalConfirmBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 transition duration-300">تأكيد</button>
                <button id="modalCancelBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400 transition duration-300">إلغاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId;

        // --- Firebase Initialization and Authentication ---
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `ID: ${userId}`;
                        console.log("Firebase initialized and authenticated successfully.");
                        // Start rendering after auth state is confirmed
                        showSection('students');
                        renderAllTables();
                    } else {
                        console.error("User is not authenticated.");
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // --- Data Retrieval with Real-time Listeners (onSnapshot) ---
        function renderAllTables() {
            if (!db || !userId) {
                console.warn("Database or user ID not ready. Skipping render.");
                return;
            }

            // Real-time listener for students table
            const studentsCol = collection(db, `/artifacts/${appId}/public/data/students`);
            onSnapshot(studentsCol, (snapshot) => {
                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudentsTable(students);
                loadStudentsDropdown(students);
            });

            // Real-time listener for texts tables
            const textsCol = collection(db, `/artifacts/${appId}/public/data/texts`);
            onSnapshot(textsCol, (snapshot) => {
                const texts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTextsTables(texts);
            });
        }
        
        // --- Helper Functions ---
        
        // Displays a custom modal for confirmations or alerts
        function showModal(message, isConfirm = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const msg = document.getElementById('modalMessage');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');

                msg.textContent = message;
                modal.classList.remove('hidden');
                modal.querySelector('.modal-content').classList.remove('animate-fade-out');
                modal.querySelector('.modal-content').classList.add('animate-fade-in');

                if (isConfirm) {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                } else {
                    confirmBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                }

                const handleConfirm = () => {
                    modal.querySelector('.modal-content').classList.add('animate-fade-out');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.querySelector('.modal-content').classList.add('animate-fade-out');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                    resolve(false);
                };

                confirmBtn.onclick = handleConfirm;
                cancelBtn.onclick = handleCancel;

                if (!isConfirm) {
                    setTimeout(handleCancel, 2000); // Auto-dismiss after 2 seconds for alerts
                }
            });
        }

        // Toggles visibility of application sections
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Toggles visibility of text tabs
        function showTextTab(stageId) {
            document.querySelectorAll('.text-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(stageId + 'Texts').classList.remove('hidden');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active', 'bg-white', 'border-white');
                tab.classList.add('bg-gray-200');
            });

            const activeTab = event.target;
            activeTab.classList.add('active', 'bg-white', 'border-white');
            activeTab.classList.remove('bg-gray-200');
        }

        // --- Student Management Functions ---
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newStudent = {
                name: document.getElementById('studentName').value,
                college: document.getElementById('studentCollege').value,
                major: document.getElementById('studentMajor').value,
                level: document.getElementById('studentLevel').value,
            };

            const studentsCol = collection(db, `/artifacts/${appId}/public/data/students`);
            await addDoc(studentsCol, newStudent);
            this.reset();
            showModal('تمت إضافة الطالب بنجاح!');
        });

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            if (students.length === 0) {
                tbody.innerHTML = `<tr class="text-center"><td colspan="5" class="py-4 text-gray-500">لا يوجد طلاب مسجلون.</td></tr>`;
                return;
            }
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'text-center border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4">${student.name}</td>
                    <td class="py-3 px-4">${student.college}</td>
                    <td class="py-3 px-4">${student.major}</td>
                    <td class="py-3 px-4">المستوى ${student.level}</td>
                    <td class="py-3 px-4">
                        <button class="bg-red-500 text-white font-bold py-1 px-3 rounded-md hover:bg-red-600 transition duration-300" onclick="deleteStudent('${student.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteStudent(id) {
            const confirmed = await showModal('هل أنت متأكد من حذف هذا الطالب؟', true);
            if (confirmed) {
                const docRef = doc(db, `/artifacts/${appId}/public/data/students`, id);
                await deleteDoc(docRef);
                showModal('تم حذف الطالب.');
            }
        }

        // --- Text Management Functions ---
        document.getElementById('addStage1TextForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newText = {
                stage: 1,
                name: document.getElementById('stage1TextName').value,
                total: parseInt(document.getElementById('stage1TextTotal').value),
            };

            const textsCol = collection(db, `/artifacts/${appId}/public/data/texts`);
            await addDoc(textsCol, newText);
            this.reset();
            showModal('تمت إضافة المتن بنجاح!');
        });

        function renderTextsTables(texts) {
            const stage1Texts = texts.filter(text => text.stage === 1);
            const stage1Tbody = document.getElementById('stage1TextsTableBody');
            renderTextTable(stage1Tbody, stage1Texts);
            // Add other stages here if you expand the app
        }

        function renderTextTable(tbody, texts) {
            tbody.innerHTML = '';
            if (texts.length === 0) {
                tbody.innerHTML = `<tr class="text-center"><td colspan="3" class="py-4 text-gray-500">لا يوجد متون مسجلة.</td></tr>`;
                return;
            }
            texts.forEach(text => {
                const tr = document.createElement('tr');
                tr.className = 'text-center border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4">${text.name}</td>
                    <td class="py-3 px-4">${text.total}</td>
                    <td class="py-3 px-4">
                        <button class="bg-red-500 text-white font-bold py-1 px-3 rounded-md hover:bg-red-600 transition duration-300" onclick="deleteText('${text.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteText(id) {
            const confirmed = await showModal('هل أنت متأكد من حذف هذا المتن؟', true);
            if (confirmed) {
                const docRef = doc(db, `/artifacts/${appId}/public/data/texts`, id);
                await deleteDoc(docRef);
                showModal('تم حذف المتن.');
            }
        }

        // --- Progress Recording Functions ---
        function loadStudentsDropdown(students) {
            const select = document.getElementById('progressStudent');
            select.innerHTML = '<option value="">-- اختر الطالب --</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }

        function loadStageTexts() {
            const stage = document.getElementById('progressStage').value;
            const select = document.getElementById('progressText');
            select.innerHTML = '<option value="">-- اختر المتن --</option>';

            if (stage && db) {
                const textsCol = collection(db, `/artifacts/${appId}/public/data/texts`);
                const q = query(textsCol, where("stage", "==", parseInt(stage)));
                onSnapshot(q, (snapshot) => {
                    const texts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    texts.forEach(text => {
                        const option = document.createElement('option');
                        option.value = text.id;
                        option.textContent = text.name;
                        option.setAttribute('data-total', text.total);
                        select.appendChild(option);
                    });
                });
            }
        }

        document.getElementById('recordProgressForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const studentId = document.getElementById('progressStudent').value;
            const stage = document.getElementById('progressStage').value;
            const textSelect = document.getElementById('progressText');
            const textId = textSelect.value;
            const amount = parseInt(document.getElementById('progressAmount').value);
            const date = document.getElementById('progressDate').value;
            
            const selectedOption = textSelect.selectedOptions[0];
            const textTotal = parseInt(selectedOption.getAttribute('data-total'));

            if (amount > textTotal) {
                await showModal('القدر المحفوظ لا يمكن أن يكون أكبر من المجموع الكلي للمتن!');
                return;
            }
            
            const newProgress = {
                studentId,
                stage,
                textId,
                amount,
                remaining: textTotal - amount,
                date
            };

            const progressCol = collection(db, `/artifacts/${appId}/public/data/progress`);
            await addDoc(progressCol, newProgress);
            this.reset();
            showModal('تم تسجيل التقدم بنجاح!');
        });

        // Initialize the app on page load
        window.onload = initFirebase;
    </script>
</body>
</html>
