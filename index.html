<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام متابعة حفظ المتون - إصدار الكلاود (Firestore)</title>
  <style>
    :root{--primary-color:#3498db;--secondary-color:#2ecc71;--accent-color:#e74c3c;--light-color:#ecf0f1;--dark-color:#2c3e50}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background-color:#f5f7fa;color:#333;line-height:1.6}
    .container{width:90%;max-width:1200px;margin:0 auto;padding:20px}
    header{background-color:var(--dark-color);color:#fff;padding:1rem;text-align:center;margin-bottom:2rem;border-radius:5px}
    nav{background-color:var(--primary-color);padding:1rem;margin-bottom:2rem;border-radius:5px}
    nav ul{display:flex;justify-content:center;list-style:none}
    nav ul li{margin:0 15px}
    nav ul li a{color:#fff;text-decoration:none;font-weight:bold;padding:5px 10px;border-radius:3px;transition:background-color .3s}
    nav ul li a:hover{background-color:rgba(255,255,255,.2)}
    .section{background-color:#fff;padding:20px;margin-bottom:20px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.1);display:none}
    .section.active{display:block}
    h2{color:var(--dark-color);margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid var(--light-color)}
    table{width:100%;border-collapse:collapse;margin-bottom:20px}
    table,th,td{border:1px solid #ddd}
    th,td{padding:12px;text-align:center}
    th{background-color:var(--light-color)}
    tr:nth-child(even){background-color:#f9f9f9}
    .form-group{margin-bottom:15px}
    label{display:block;margin-bottom:5px;font-weight:bold}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px}
    button{background-color:var(--primary-color);color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;font-weight:bold}
    button:hover{background-color:#2980b9}
    .btn-danger{background-color:var(--accent-color)}
    .btn-danger:hover{background-color:#c0392b}
    .btn-success{background-color:var(--secondary-color)}
    .btn-success:hover{background-color:#27ae60}
    .card{border:1px solid #ddd;border-radius:5px;padding:15px;margin-bottom:15px;background-color:#fff}
    .card-header{font-weight:bold;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee}
    .tabs{display:flex;margin-bottom:20px;border-bottom:1px solid #ddd}
    .tab{padding:10px 20px;cursor:pointer;background-color:#f1f1f1;border:1px solid #ddd;border-bottom:none;border-radius:5px 5px 0 0;margin-right:5px}
    .tab.active{background-color:#fff;border-bottom:1px solid #fff;margin-bottom:-1px}
    @media (max-width:768px){nav ul{flex-direction:column;align-items:center}nav ul li{margin:5px 0}.tabs{flex-wrap:wrap}.tab{margin-bottom:5px}}
    .hint{font-size:.9rem;color:#555;margin:.5rem 0}
  </style>
</head>
<body>
  <header>
    <h1>نظام متابعة حفظ المتون - الكلاود (Google Firestore)</h1>
    <p class="hint">📌 هذه النسخة تحفظ وتعرض البيانات للجميع عبر قاعدة بيانات سحابية. تأكد من ضبط <strong>firebaseConfig</strong> و<em>Security Rules</em>.</p>
  </header>

  <nav>
    <ul>
      <li><a href="#" onclick="showSection('students')">إدارة الطلاب</a></li>
      <li><a href="#" onclick="showSection('texts')">إدارة المتون</a></li>
      <li><a href="#" onclick="showSection('progress')">تسجيل التقدم</a></li>
      <li><a href="#" onclick="showSection('weekly')">التقارير الأسبوعية</a></li>
      <li><a href="#" onclick="showSection('monthly')">التقارير الشهرية</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- الطلاب -->
    <section id="students" class="section">
      <h2>إدارة الطلاب</h2>
      <div class="card">
        <div class="card-header">إضافة طالب جديد</div>
        <form id="addStudentForm">
          <div class="form-group">
            <label for="studentName">اسم الطالب</label>
            <input type="text" id="studentName" required />
          </div>
          <div class="form-group">
            <label for="studentCollege">الكليّة</label>
            <input type="text" id="studentCollege" required />
          </div>
          <div class="form-group">
            <label for="studentMajor">التخصص</label>
            <input type="text" id="studentMajor" required />
          </div>
          <div class="form-group">
            <label for="studentLevel">المستوى</label>
            <select id="studentLevel" required>
              <option value="1">المستوى الأول</option>
              <option value="2">المستوى الثاني</option>
              <option value="3">المستوى الثالث</option>
              <option value="4">المستوى الرابع</option>
            </select>
          </div>
          <button type="submit" class="btn-success">إضافة الطالب</button>
        </form>
      </div>

      <div class="card">
        <div class="card-header">قائمة الطلاب</div>
        <table id="studentsTable">
          <thead>
            <tr>
              <th>الاسم</th>
              <th>الكليّة</th>
              <th>التخصص</th>
              <th>المستوى</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- المتون -->
    <section id="texts" class="section">
      <h2>إدارة المتون</h2>
      <div class="tabs">
        <div class="tab active" data-stage="1" onclick="showTextTab('stage1', event)">المرحلة الأولى</div>
        <div class="tab" data-stage="2" onclick="showTextTab('stage2', event)">المرحلة الثانية</div>
        <div class="tab" data-stage="3" onclick="showTextTab('stage3', event)">المرحلة الثالثة</div>
        <div class="tab" data-stage="4" onclick="showTextTab('stage4', event)">المرحلة الرابعة</div>
      </div>

      <!-- قالب مرحلة عام باستخدام data-stage="1..4" -->
      <div id="stage1Texts" class="text-tab" data-stage="1">
        <div class="card">
          <div class="card-header">إضافة متن جديد للمرحلة الأولى</div>
          <form class="addTextForm" data-stage="1">
            <div class="form-group">
              <label>اسم المتن</label>
              <input type="text" class="textName" required />
            </div>
            <div class="form-group">
              <label>العدد الكلي للصفحات/الأجزاء</label>
              <input type="number" min="1" class="textTotal" required />
            </div>
            <button type="submit" class="btn-success">إضافة المتن</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">متون المرحلة الأولى</div>
          <table class="textsTable" id="stage1TextsTable">
            <thead>
              <tr>
                <th>اسم المتن</th>
                <th>المجموع الكلي</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- سننسخ نفس البنية للمراحل الأخرى -->
      <div id="stage2Texts" class="text-tab" data-stage="2" style="display:none">
        <div class="card">
          <div class="card-header">إضافة متن جديد للمرحلة الثانية</div>
          <form class="addTextForm" data-stage="2">
            <div class="form-group">
              <label>اسم المتن</label>
              <input type="text" class="textName" required />
            </div>
            <div class="form-group">
              <label>العدد الكلي للصفحات/الأجزاء</label>
              <input type="number" min="1" class="textTotal" required />
            </div>
            <button type="submit" class="btn-success">إضافة المتن</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">متون المرحلة الثانية</div>
          <table class="textsTable" id="stage2TextsTable">
            <thead>
              <tr>
                <th>اسم المتن</th>
                <th>المجموع الكلي</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="stage3Texts" class="text-tab" data-stage="3" style="display:none">
        <div class="card">
          <div class="card-header">إضافة متن جديد للمرحلة الثالثة</div>
          <form class="addTextForm" data-stage="3">
            <div class="form-group">
              <label>اسم المتن</label>
              <input type="text" class="textName" required />
            </div>
            <div class="form-group">
              <label>العدد الكلي للصفحات/الأجزاء</label>
              <input type="number" min="1" class="textTotal" required />
            </div>
            <button type="submit" class="btn-success">إضافة المتن</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">متون المرحلة الثالثة</div>
          <table class="textsTable" id="stage3TextsTable">
            <thead>
              <tr>
                <th>اسم المتن</th>
                <th>المجموع الكلي</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="stage4Texts" class="text-tab" data-stage="4" style="display:none">
        <div class="card">
          <div class="card-header">إضافة متن جديد للمرحلة الرابعة</div>
          <form class="addTextForm" data-stage="4">
            <div class="form-group">
              <label>اسم المتن</label>
              <input type="text" class="textName" required />
            </div>
            <div class="form-group">
              <label>العدد الكلي للصفحات/الأجزاء</label>
              <input type="number" min="1" class="textTotal" required />
            </div>
            <button type="submit" class="btn-success">إضافة المتن</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">متون المرحلة الرابعة</div>
          <table class="textsTable" id="stage4TextsTable">
            <thead>
              <tr>
                <th>اسم المتن</th>
                <th>المجموع الكلي</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- تسجيل التقدم -->
    <section id="progress" class="section">
      <h2>تسجيل التقدم في الحفظ</h2>
      <div class="card">
        <form id="recordProgressForm">
          <div class="form-group">
            <label for="progressStudent">اختر الطالب</label>
            <select id="progressStudent" required>
              <option value="">-- اختر الطالب --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="progressStage">المرحلة</label>
            <select id="progressStage" required>
              <option value="">-- اختر المرحلة --</option>
              <option value="1">المرحلة الأولى</option>
              <option value="2">المرحلة الثانية</option>
              <option value="3">المرحلة الثالثة</option>
              <option value="4">المرحلة الرابعة</option>
            </select>
          </div>
          <div class="form-group">
            <label for="progressText">المتن</label>
            <select id="progressText" required>
              <option value="">-- اختر المتن --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="progressAmount">القدر المحفوظ (مكان الوقف)</label>
            <input type="number" id="progressAmount" required />
          </div>
          <div class="form-group">
            <label for="progressDate">تاريخ التسميع</label>
            <input type="date" id="progressDate" required />
          </div>
          <button type="submit" class="btn-success">تسجيل التقدم</button>
        </form>
        <p class="hint">سيتم التحقق تلقائيًا من عدم تجاوز القدر للمجموع الكلي للمتن.</p>
      </div>
    </section>

    <!-- تقارير (تجهيز للنسخة القادمة) -->
    <section id="weekly" class="section">
      <h2>التقارير الأسبوعية</h2>
      <div class="card">
        <div class="form-group">
          <label for="weeklyReportWeek">اختر الأسبوع</label>
          <input type="week" id="weeklyReportWeek" />
        </div>
        <p class="hint">❗️ ملاحظة: تجميع التقارير سيتم ربطه لاحقًا باستعلامات Firestore حسب التواريخ.</p>
      </div>
      <div class="card">
        <div class="card-header">التقرير الأسبوعي</div>
        <table id="weeklyReportTable">
          <thead>
            <tr>
              <th>اسم الطالب</th>
              <th>الكليّة</th>
              <th>التخصص</th>
              <th>أيام التسميع</th>
              <th>أيام عدم التسميع</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="monthly" class="section">
      <h2>التقارير الشهرية</h2>
      <div class="card">
        <div class="form-group">
          <label for="monthlyReportMonth">اختر الشهر</label>
          <input type="month" id="monthlyReportMonth" />
        </div>
        <p class="hint">❗️ ملاحظة: سيتم تفعيل التجميع الشهري لاحقًا باستعلامات زمنية من Firestore.</p>
      </div>
      <div class="card">
        <div class="card-header">التقرير الشهري</div>
        <table id="monthlyReportTable">
          <thead>
            <tr>
              <th>اسم الطالب</th>
              <th>الكليّة</th>
              <th>التخصص</th>
              <th>أيام التسميع</th>
              <th>أيام عدم التسميع</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Firebase + منطق التطبيق -->
  <script type="module">
    /**
     * 1) ألصِق إعدادات Firebase لمشروعك هنا (من لوحة Firebase > Project Settings > SDK setup & config)
     * ⚠️ لا تشارك المفاتيح الحساسة علنًا. يُنصح بضبط قواعد الأمان.
     */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, onSnapshot,
      deleteDoc, doc, query, where, orderBy, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // المراجع
    const studentsCol = collection(db, 'students');
    const textsCol = collection(db, 'texts'); // سنخزن: { name, total, stage }
    const progressCol = collection(db, 'progress'); // { studentId, stage, textId, amount, remaining, date }

    // حالة واجهة المستخدم
    const studentsState = new Map(); // id -> data
    const textsState = new Map(); // id -> data

    // ====== أدوات عامة للواجهة ======
    function showSection(sectionId){
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      if(sectionId==='students'){ renderStudentsTable(); }
      if(sectionId==='texts'){ /* الجداول تتحدث آليًا عبر onSnapshot */ }
      if(sectionId==='progress'){ loadStudentsDropdown(); }
    }

    function showTextTab(stageId, ev){
      document.querySelectorAll('.text-tab').forEach(tab=>tab.style.display='none');
      document.getElementById(stageId+'Texts').style.display='block';
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      if(ev) ev.target.classList.add('active');
      renderTextsTables();
    }

    // ====== الطلاب ======
    const addStudentForm = document.getElementById('addStudentForm');
    addStudentForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const student = {
        name: document.getElementById('studentName').value.trim(),
        college: document.getElementById('studentCollege').value.trim(),
        major: document.getElementById('studentMajor').value.trim(),
        level: document.getElementById('studentLevel').value
      };
      if(!student.name) return alert('الاسم مطلوب');
      await addDoc(studentsCol, student);
      addStudentForm.reset();
      alert('تم إضافة الطالب بنجاح!');
    });

    function renderStudentsTable(){
      const tbody = document.querySelector('#studentsTable tbody');
      tbody.innerHTML = '';
      [...studentsState.entries()].forEach(([id, student])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${student.name}</td>
          <td>${student.college}</td>
          <td>${student.major}</td>
          <td>المستوى ${student.level}</td>
          <td><button class="btn-danger" data-del-student="${id}">حذف</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-del-student]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del-student');
          if(confirm('هل أنت متأكد من حذف هذا الطالب؟')){
            await deleteDoc(doc(db, 'students', id));
          }
        });
      });
    }

    // متابعة حيّة لقائمة الطلاب
    onSnapshot(studentsCol, (snap)=>{
      studentsState.clear();
      snap.forEach(d=>studentsState.set(d.id, d.data()));
      renderStudentsTable();
      loadStudentsDropdown();
    });

    // ====== المتون ======
    // نماذج الإضافة لكل مرحلة
    document.querySelectorAll('.addTextForm').forEach(form=>{
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const stage = form.getAttribute('data-stage');
        const name = form.querySelector('.textName').value.trim();
        const total = parseInt(form.querySelector('.textTotal').value, 10);
        if(!name || !total || total<1) return alert('أدخل اسم المتن وعددًا صحيحًا');
        await addDoc(textsCol, { name, total, stage });
        form.reset();
        alert('تم إضافة المتن بنجاح!');
      });
    });

    function renderTextsTables(){
      // امسح الجداول الأربعة ثم املأ حسب الحالة
      for(let s=1; s<=4; s++){
        const tbody = document.querySelector(`#stage${s}TextsTable tbody`);
        if(!tbody) continue;
        tbody.innerHTML='';
        [...textsState.entries()] // [id, data]
          .filter(([_, t])=> String(t.stage)===String(s))
          .forEach(([id, t])=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${t.name}</td>
              <td>${t.total}</td>
              <td><button class="btn-danger" data-del-text="${id}">حذف</button></td>`;
            tbody.appendChild(tr);
          });
        tbody.querySelectorAll('[data-del-text]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.getAttribute('data-del-text');
            if(confirm('هل أنت متأكد من حذف هذا المتن؟')){
              await deleteDoc(doc(db,'texts',id));
            }
          });
        });
      }
    }

    // متابعة حيّة للمتون
    onSnapshot(textsCol, (snap)=>{
      textsState.clear();
      snap.forEach(d=>textsState.set(d.id, d.data()));
      renderTextsTables();
      // حدّث قائمة المتون في نموذج التقدم إن كانت مرحلة مختارة
      populateTextsDropdown();
    });

    // ====== تسجيل التقدم ======
    function loadStudentsDropdown(){
      const select = document.getElementById('progressStudent');
      if(!select) return;
      const current = select.value;
      select.innerHTML = '<option value="">-- اختر الطالب --</option>';
      [...studentsState.entries()].forEach(([id, s])=>{
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = s.name;
        select.appendChild(opt);
      });
      // احتفظ بالاختيار إن أمكن
      if(current) select.value = current;
      populateTextsDropdown();
    }

    const progressStageSel = document.getElementById('progressStage');
    const progressTextSel = document.getElementById('progressText');

    function populateTextsDropdown(){
      if(!progressStageSel || !progressTextSel) return;
      const stage = progressStageSel.value;
      progressTextSel.innerHTML = '<option value="">-- اختر المتن --</option>';
      if(!stage) return;
      [...textsState.entries()]
        .filter(([_, t])=> String(t.stage)===String(stage))
        .forEach(([id, t])=>{
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = t.name; opt.dataset.total = t.total;
          progressTextSel.appendChild(opt);
        });
    }

    progressStageSel.addEventListener('change', populateTextsDropdown);

    document.getElementById('recordProgressForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const studentId = document.getElementById('progressStudent').value;
      const stage = document.getElementById('progressStage').value;
      const textId = document.getElementById('progressText').value;
      const amount = parseInt(document.getElementById('progressAmount').value, 10);
      const date = document.getElementById('progressDate').value; // YYYY-MM-DD
      if(!studentId || !stage || !textId || !amount || !date) return alert('أكمل جميع الحقول');
      const total = parseInt(progressTextSel.selectedOptions[0].dataset.total, 10);
      if(amount>total) return alert('القدر المحفوظ لا يمكن أن يكون أكبر من المجموع الكلي للمتن!');
      const remaining = total - amount;
      await addDoc(progressCol, { studentId, stage, textId, amount, remaining, date });
      e.target.reset();
      alert('تم تسجيل التقدم بنجاح!');
    });

    // ====== بدء التشغيل ======
    document.addEventListener('DOMContentLoaded', ()=>{
      showSection('students');
      showTextTab('stage1');
    });
  </script>

  <!-- تلميحات أمان Firestore (للتنفيذ من لوحة التحكم):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // 👇 للسماح العام للقراءة والكتابة أثناء التطوير فقط (غير آمن للإنتاج)
      match /{document=**} {
        allow read, write: if true;
      }
      // للإنتاج، استخدم مصادقة وتحقق من الملكية والأدوار.
    }
  }
  -->
</body>
</html>
